<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Portal - Decentralized Bank</title>
    <link rel="stylesheet" href="admin-style.css">
</head>

<body>
    <div class="container">
        <header>
            <div style="display: flex; align-items: center; gap: 1rem;">
                <h2 style="color: var(--accent);">ADMIN PORTAL</h2>
                <span class="badge badge-TRANSFER">Node 1</span>
            </div>
            <button onclick="logout()" class="btn-danger" style="width: auto; padding: 0.5rem 1.5rem;">Secure
                Exit</button>
        </header>

        <!-- Stats Row -->
        <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 1.5rem; margin-bottom: 2rem;">
            <div class="card" style="text-align: center;">
                <h3 style="color: var(--text-secondary); font-size: 0.9rem; text-transform: uppercase;">Total Reserves
                </h3>
                <div class="balance-amount" style="font-size: 2.5rem;" id="stat-reserves">$0</div>
            </div>
            <div class="card" style="text-align: center;">
                <h3 style="color: var(--text-secondary); font-size: 0.9rem; text-transform: uppercase;">Active Users
                </h3>
                <div class="balance-amount" style="font-size: 2.5rem;" id="stat-users">0</div>
            </div>
            <div class="card" style="text-align: center;">
                <h3 style="color: var(--text-secondary); font-size: 0.9rem; text-transform: uppercase;">Total
                    Transactions</h3>
                <div class="balance-amount" style="font-size: 2.5rem;" id="stat-tx">0</div>
            </div>
        </div>

        <div class="grid-2" style="display: grid; grid-template-columns: 2fr 1fr; gap: 1.5rem;">
            <!-- Left: Transaction Logs -->
            <div class="card">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                    <h3>Live Transaction Feed</h3>
                    <button onclick="loadAll()" class="btn-primary"
                        style="width: auto; padding: 0.5rem 1rem; font-size: 0.8rem;">Refresh Data</button>
                </div>

                <!-- Filters -->
                <div class="filter-container">
                    <div class="filter-group">
                        <div class="input-group" style="max-width: 250px;">
                            <input type="text" id="filter-account" placeholder=" " onkeyup="applyFilters()"
                                style="width: 100%;">
                            <label>Search User ID</label>
                        </div>
                    </div>
                    <div class="filter-group">
                        <div class="input-group">
                            <input type="number" id="filter-node" placeholder=" " onkeyup="applyFilters()">
                            <label>Filter by Node</label>
                        </div>
                    </div>
                    <div class="filter-group">
                        <div class="input-group">
                            <select id="filter-period" onchange="applyFilters()">
                                <option value="all">All Time</option>
                                <option value="today">Today</option>
                                <option value="week">Last 7 Days</option>
                                <option value="month">Last 30 Days</option>
                                <option value="specific">Specific Date</option>
                            </select>
                            <label>Time Period</label>
                        </div>
                    </div>
                    <div class="filter-group">
                        <!-- Label spacer to align button -->
                        <label style="visibility: hidden;">Action</label>
                        <button onclick="resetFilters()" class="btn-danger" style="margin-bottom: 0;">Reset
                            Filters</button>
                    </div>

                    <!-- Specific Time Input (Hidden by default) -->
                    <div id="specific-time-container">
                        <div style="display: flex; align-items: center; gap: 15px;">
                            <span style="color: var(--accent); font-weight: 600; font-size: 0.9rem;">
                                <i class="fas fa-calendar-alt"></i> Select Date:
                            </span>
                            <div class="input-group" style="margin-bottom: 0; min-width: 200px;">
                                <input type="date" id="filter-specific" onchange="applyFilters()">
                            </div>
                        </div>
                        <span
                            style="color: var(--text-secondary); font-size: 0.8rem; margin-left: auto; letter-spacing: 0.5px;">
                            (Logs filtered for the entire chosen day)
                        </span>
                    </div>
                </div>

                <div style="overflow-x: auto;">
                    <table id="logs-table">
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>Time</th>
                                <th>Type</th>
                                <th>User</th>
                                <th>Amount</th>
                                <th>Target</th>
                                <th>Node</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td colspan="7" style="text-align:center; color: var(--text-secondary);">Connecting to
                                    Distributed Ledger...</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Right: User Monitor -->
            <div class="card">
                <h3>Customer List</h3>
                <div style="overflow-x: auto; margin-top: 1rem;">
                    <table id="users-table">
                        <thead>
                            <tr>
                                <th>User ID</th>
                                <th>Name</th>
                                <th>Balance</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td colspan="3" style="text-align:center;">Loading...</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <script>
        if (localStorage.getItem('userRole') !== 'admin') {
            window.location.href = 'login.html';
        }

        let allTransactionLogs = [];

        function logout() {
            localStorage.removeItem('currentUser');
            localStorage.removeItem('currentUserName');
            localStorage.removeItem('userRole');
            window.location.href = 'login.html';
        }

        async function loadAll() {
            loadStats();
            loadLogs();
            loadUsers();
        }

        async function loadStats() {
            try {
                const res = await fetch('/api/admin/stats');
                const stats = await res.json();
                document.getElementById('stat-users').innerText = Number(stats.totalUsers).toLocaleString();
                document.getElementById('stat-reserves').innerText = '$' + Number(stats.totalReserves).toLocaleString();
                document.getElementById('stat-tx').innerText = Number(stats.totalTransactions).toLocaleString();
            } catch (e) {
                console.error("Stats Error:", e);
            }
        }

        async function loadLogs() {
            try {
                const res = await fetch('/api/admin/logs');
                allTransactionLogs = await res.json(); // Store globally
                applyFilters(); // Render with current filters
            } catch (e) {
                console.error(e);
            }
        }

        function applyFilters() {
            const accountFilter = document.getElementById('filter-account').value.trim().toLowerCase();
            const nodeFilter = document.getElementById('filter-node').value;
            const periodFilter = document.getElementById('filter-period').value;

            // Toggle Specific Time Visibility
            const specificContainer = document.getElementById('specific-time-container');
            if (periodFilter === 'specific') {
                specificContainer.style.display = 'flex';
            } else {
                specificContainer.style.display = 'none';
            }

            const tbody = document.querySelector('#logs-table tbody');
            tbody.innerHTML = '';

            const now = new Date();
            const startOfDay = new Date(now.getFullYear(), now.getMonth(), now.getDate()).getTime();
            const oneWeekAgo = now.getTime() - (7 * 24 * 60 * 60 * 1000);
            const oneMonthAgo = now.getTime() - (30 * 24 * 60 * 60 * 1000);

            const filtered = allTransactionLogs.filter(log => {
                // 1. Account Filter (User ONLY)
                // User requested to filter only by the Initiator User ID, not Target.
                const matchesAccount = !accountFilter || log.user.toLowerCase().includes(accountFilter);

                // 2. Node Filter
                const matchesNode = !nodeFilter || log.node.toString() === nodeFilter;

                // 3. Time Period Filter
                let matchesTime = true;
                // timestamp format: "yyyy-MM-dd HH:mm:ss"
                // Parse manually for compatibility or use Date.parse (assuming logical format)
                const logTime = new Date(log.timestamp).getTime();

                if (periodFilter === 'today') {
                    matchesTime = logTime >= startOfDay;
                } else if (periodFilter === 'week') {
                    matchesTime = logTime >= oneWeekAgo;
                } else if (periodFilter === 'month') {
                    matchesTime = logTime >= oneMonthAgo;
                } else if (periodFilter === 'specific') {
                    const specificInput = document.getElementById('filter-specific').value; // "yyyy-MM-dd"
                    if (specificInput) {
                        // Create prefix string: "yyyy-MM-dd"
                        matchesTime = log.timestamp.startsWith(specificInput);
                    }
                }

                return matchesAccount && matchesNode && matchesTime;
            });

            // Sort by timestamp (most recent first)
            filtered.sort((a, b) => {
                // Compare timestamps in descending order (newest first)
                return b.timestamp.localeCompare(a.timestamp);
            });

            if (filtered.length === 0) {
                tbody.innerHTML = '<tr><td colspan="7" style="text-align:center; padding: 2rem; color: var(--text-secondary);">No matching transactions found.</td></tr>';
                return;
            }

            filtered.forEach((log, index) => {
                const tr = document.createElement('tr');
                tr.className = 'log-row';
                tr.style.animationDelay = `${index * 0.05}s`; // Staggered animation
                tr.classList.add('animate-entry');

                tr.innerHTML = `
                    <td style="color: var(--text-secondary); font-family: monospace;">#${log.id}</td>
                    <td style="font-size: 0.85rem;">${log.timestamp}</td>
                    <td><span class="badge badge-${log.type}">${log.type}</span></td>
                    <td>${log.user}</td>
                    <td style="font-weight:bold; color: var(--text-primary);">$${Number(log.amount).toLocaleString()}</td>
                    <td>${log.target || '-'}</td>
                    <td><span style="color: var(--text-secondary);">Node ${log.node}</span></td>
                `;
                tbody.appendChild(tr);
            });
        }

        function resetFilters() {
            document.getElementById('filter-account').value = '';
            document.getElementById('filter-node').value = '';
            document.getElementById('filter-period').value = 'all';
            document.getElementById('filter-specific').value = '';
            applyFilters();
        }

        async function loadUsers() {
            try {
                const res = await fetch('/api/admin/users');
                const users = await res.json();
                const tbody = document.querySelector('#users-table tbody');
                tbody.innerHTML = '';

                users.forEach(u => {
                    const tr = document.createElement('tr');
                    tr.innerHTML = `
                        <td style="font-family: monospace;">${u.id}</td>
                        <td>${u.name}</td>
                        <td style="color: var(--success); font-weight: bold;">$${Number(u.balance).toLocaleString()}</td>
                    `;
                    tbody.appendChild(tr);
                });
            } catch (e) {
                console.error(e);
            }
        }

        // Initial Load
        loadAll();
        // Auto-refresh every 5s
        setInterval(loadAll, 5000);
    </script>
</body>

</html>