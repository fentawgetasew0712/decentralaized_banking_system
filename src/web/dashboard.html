<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard - Decentralized Bank</title>
    <link rel="stylesheet" href="style.css">
</head>

<body>
    <div class="container">
        <header>
            <h1>Decentralized Banking</h1>
            <div style="display: flex; align-items: center; gap: 1rem;">
                <div id="status-bar"><span id="welcome-msg"
                        style="font-weight: bold; color: var(--accent);">Welcome...</span></div>
                <button onclick="logout()" class="btn-danger"
                    style="padding: 0.5rem 1rem; font-size: 0.9rem;">Logout</button>
            </div>
        </header>

        <main>
            <div id="dashboard">
                <div class="balance-card">
                    <h3>Current Balance</h3>
                    <div class="balance-amount">$<span id="balance">Loading...</span></div>
                    <button class="refresh-btn" onclick="refreshBalance()">↻ Refresh</button>
                </div>

                <div class="actions-grid">
                    <div class="card action-card">
                        <h3>Withdraw</h3>
                        <div class="input-group">
                            <input type="number" id="withdraw-amount" placeholder=" " min="1"
                                oninput="this.className=this.value?'valid':''">
                            <label>Amount to Withdraw</label>
                        </div>
                        <button id="btn-WITHDRAW" class="btn-danger"
                            onclick="performAction('WITHDRAW')">Withdraw</button>
                    </div>

                    <div class="card action-card">
                        <h3>Deposit</h3>
                        <div class="input-group">
                            <input type="number" id="deposit-amount" placeholder=" " min="1"
                                oninput="this.className=this.value?'valid':''">
                            <label>Amount to Deposit</label>
                        </div>
                        <button id="btn-DEPOSIT" class="btn-success" onclick="performAction('DEPOSIT')">Deposit</button>
                    </div>

                    <div class="card action-card" style="grid-column: span 2;">
                        <h3>Transfer Funds</h3>
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-top: 10px;">
                            <div class="input-group">
                                <input type="text" id="transfer-target" placeholder=" "
                                    oninput="this.className=this.value?'valid':''">
                                <label>Recipient Account ID</label>
                            </div>
                            <div class="input-group">
                                <input type="number" id="transfer-amount" placeholder=" " min="1"
                                    oninput="this.className=this.value?'valid':''">
                                <label>Transfer Amount</label>
                            </div>
                        </div>
                        <button id="btn-TRANSFER" class="btn-primary" onclick="performAction('TRANSFER')">Confirm
                            Transfer</button>
                    </div>
                </div>

                <div class="card log-card">
                    <h3>Recent Logs</h3>
                    <div id="logs"></div>
                </div>
            </div>
        </main>
    </div>

    <script>
        // Get user from storage
        const currentUser = localStorage.getItem('currentUser');
        const currentUserName = localStorage.getItem('currentUserName');

        if (!currentUser) {
            window.location.href = 'login.html'; // Redirect to login if no user
        }

        document.getElementById('welcome-msg').innerText = "Welcome, " + (currentUserName || currentUser) + " (" + currentUser + ")";

        // Initial Load
        refreshBalance();

        async function logout() {
            try {
                // Call backend to release session lock
                await fetch('/api/logout', {
                    method: 'POST',
                    body: JSON.stringify({ user: currentUser })
                });
            } catch (e) {
                console.error("Logout failed on server", e);
            }

            localStorage.removeItem('currentUser');
            localStorage.removeItem('currentUserName');
            window.location.href = 'login.html';
        }

        async function refreshBalance() {
            const btn = document.querySelector('.refresh-btn');
            const originalText = btn.innerText;
            btn.innerText = "↻ ...";
            btn.disabled = true;

            try {
                // Add timestamp to prevent caching
                const res = await fetch(`/api/balance?user=${currentUser}&t=${Date.now()}`);
                if (res.status !== 200) throw new Error("Failed");
                const data = await res.text();
                const formattedBalance = Number(data).toLocaleString();
                document.getElementById('balance').innerText = formattedBalance;
                log("Balance updated: $" + formattedBalance);
            } catch (e) {
                document.getElementById('balance').innerText = "Error";
                log("Error: Could not connect to Bank Node.");
            } finally {
                btn.innerText = originalText;
                btn.disabled = false;
            }
        }

        async function performAction(type) {
            let amount, target = '';
            const btn = document.getElementById(`btn-${type}`);
            const originalText = btn.innerText;
            const originalClass = btn.className;

            if (type === 'WITHDRAW') amount = document.getElementById('withdraw-amount').value;
            if (type === 'DEPOSIT') amount = document.getElementById('deposit-amount').value;
            if (type === 'TRANSFER') {
                amount = document.getElementById('transfer-amount').value;
                target = document.getElementById('transfer-target').value;
            }

            if (!amount || Number(amount) <= 0) {
                alert("Please enter a valid amount greater than zero");
                return;
            }
            if (type === 'TRANSFER' && !target) {
                alert("Please enter a recipient");
                return;
            }

            // Show processing state
            btn.disabled = true;
            btn.innerText = "Processing...";
            btn.style.opacity = "0.7";
            log(`Requesting ${type} for ${currentUser}...`);

            try {
                const res = await fetch('/api/action', {
                    method: 'POST',
                    body: JSON.stringify({ type, user: currentUser, amount, target })
                });
                const result = await res.text();
                log(result);

                // Check if successful
                if (result.startsWith("OK")) {
                    // Success state
                    btn.className = "btn-success";
                    btn.innerText = "Success ✓";
                    btn.style.opacity = "1";

                    // Poll for balance update
                    setTimeout(refreshBalance, 1000);
                    setTimeout(refreshBalance, 3000);
                } else {
                    // Failed state
                    btn.className = "btn-danger";
                    btn.innerText = "Failed ✗";
                    btn.style.opacity = "1";
                }

                // Reset button after 3 seconds
                setTimeout(() => {
                    btn.disabled = false;
                    btn.innerText = originalText;
                    btn.className = originalClass;
                    btn.style.opacity = "1";
                }, 3000);

            } catch (e) {
                log("Action failed: Network Error");

                // Network error state
                btn.className = "btn-danger";
                btn.innerText = "Failed ✗";
                btn.style.opacity = "1";

                // Reset button after 3 seconds
                setTimeout(() => {
                    btn.disabled = false;
                    btn.innerText = originalText;
                    btn.className = originalClass;
                    btn.style.opacity = "1";
                }, 3000);
            }
        }

        function log(msg) {
            const logs = document.getElementById('logs');
            const entry = document.createElement('div');
            entry.innerText = `> ${msg}`;
            logs.insertBefore(entry, logs.firstChild);
        }
    </script>
</body>

</html>